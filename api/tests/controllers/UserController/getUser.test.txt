
import {  test } from '@jest/globals';
import { users } from '../../__mocks__/users';
import request from "supertest";
import { MongoTestContainer } from '../../MongoTestContainer';

import {log } from "console"
import { DataSource, Repository } from 'typeorm';
import { User } from '../../../src/entities/User.entity';
import { IUserRepository } from '../../../src/interfaces/IUserRepository.interface';
import { UserRepository } from '../../../src/repositories/UserRepository.repository';
import { buildApp, getContainer } from '../../../src/app';
import { Application, Router } from 'express';
import { RegisterRoutes } from '../../../src/routes';
import { iocContainer } from '../../../src/configs/ioc.config';
import { MongoDBService } from '../../../src/services/MongoDBService.service';
import { UserController } from '../../../src/controllers/UserController.controller';

const configureRoutes = () =>{
  const router = Router()
  const iocContainer = getIocContainer()
  const controller = iocContainer.get(UserController);
  router.get("/",controller.getUsers);
  router.get("/:userId", controller.getUser)
  router.post("/:userId", controller.createUser)

  router.delete("/:userId", controller.deleteUser)

  return router

  

}
async function bootstrap(app: Application) {
  await iocContainer.get(MongoDBService).connect();
  const port = 4000;
  if (process.env.NODE_ENV !== 'test') {
    app.listen(port , () => {
      console.log(`ðŸš€ Server is running on: http://localhost:${port}`);
      console.log(`ðŸ“š API Documentation: http://localhost:${port}/docs`);
    });
  }
}

describe('UserController.loginUser() login a user', () => {

  const mongoTestContainer: MongoTestContainer = new MongoTestContainer();
    let dataSource: DataSource | null = null;
    let repository : Repository<User> | null = null;
    const app = buildApp();
    const routes = configureRoutes()
    app.use("/users",routes);


    
beforeAll(async () => {
  //await bootstrap(app).catch(console.error);
  await mongoTestContainer.startTestConatiner();
  dataSource = mongoTestContainer.getDataSource();

  repository = new UserRepository(dataSource);
},5000);

afterAll(async () => {

  await mongoTestContainer.stopTestConatiner();
  

},5000);

    beforeEach(async () =>{
        await repository?.save(users);
        
    },5000);
    afterEach(async () =>{
        repository = dataSource?.getRepository(User) as Repository<User>
        await repository.clear()
    },5000); // Clear data after each test
describe('getUsers() gets all users', () => {
    RegisterRoutes(app)





      test('should get all users grafecully', async () => {
      const res = await request(app).get('/users/')
      const body = await res.body;
        //log("res:== ",res)
        log("data:== ",body)
    // displayRoutes(app)


    //   .set({"content-type":"application/json"})
    //   const e = await JSON.parse(res.text)
    //   console.log("e: ", e)
    //   console.log("res: ", res)
    //   const data = res.body.data;
      expect(1).toBeGreaterThan(0);

      //expect(data).toBeDefined();
    },4000);

});
  
//   describe('Happy Paths',  () => {

//       test('should login user successfully', async () => {

//     try{

//       const authUser : UserLoginRequestDTO = {
//         password : users[2].password as string,
//         email: users[2].email as string
//       } 
//       const res = await request(app).post('/api/v2/users/login')    
//       .set({"content-type":"application/json"})
//       .send( (JSON.stringify(authUser)))

//       const data = res.body;
//       expect(res.body.accessToken).toBeDefined();
//       expect(res.statusCode).toEqual(200);
//     }catch(e: unknown){
//       if(e instanceof Error){
//         console.log("message: ", e.message)
//                 console.log("name: ", e.name)
//                         console.log("stack: ", e.stack)


//       }
//     }    
 
//   }, 10000)

//     test('should reject missing email grafecully', async () => {
//       const authUser : UserLoginRequestDTO = {
//         password : users[2].password as string,
//         email: ""
//       } 
//       const res = await request(app)
//       .post('/api/v2/users/login')
//       .set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Validation Failed');
//       expect(e.message).toBe('All fields are mandatory!');
//       expect(e.stackTrace).toContain('Error: All fields are mandatory!');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(400);
//     },6000);

//      test('should reject missing password grafecully', async () => {
//       const authUser : UserLoginRequestDTO = {
//         password : "",
//         email: users[2].password as string,
//       } 
//       const res = await request(app)
//       .post('/api/v2/users/login')
//       .set({"content-type":"application/json"})

//       .send(JSON.stringify(authUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Validation Failed');
//       expect(e.message).toBe('All fields are mandatory!');
//       expect(e.stackTrace).toContain('Error: All fields are mandatory!');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(400);
//     },6000);

// })
//   describe('Edge cases',  () => {

//     test('should reject unregistered email gracecully', async () => {
//       const authUser : UserLoginRequestDTO = {
//         password : users[2].password as string,
//         email: "fakeemail@mail.com"
//       } 

//       const res = await request(app)
//       .post('/api/v2/users/login')
//       .set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Validation Failed');
//       expect(e.message).toBe('email does not exist');
//       expect(e.stackTrace).toContain('Error: email does not exist');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(400);
//     },6000);


//     test('should reject invalid password format gracecully', async () => {
//       const newUser = users[1]
//       newUser.password = "yrtyhgg"
//       const res = await request(app)
//       .post('/api/v2/users/login')
//       .set({"content-type":"application/json"})

//       .send(JSON.stringify(newUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Validation Failed');
//       expect(e.message).toBe('email or password is incorrect');
//       expect(e.stackTrace).toContain('Error: email or password is incorrect');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(400);
//     },6000);

//     test('should lock account with 3 failed login attempts', async () => {
//       const authUser : UserLoginRequestDTO = {
//         password : "invalid password",
//         email: users[2].email as string,
//       } 
//       //FIRST REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //SECOND REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //THIRD REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //FOURTH REQUEST
//      const res =  await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Validation Failed');
//       expect(e.message).toBe('Account is locked because of too many failed login attempts. Use /forgt route to access acount');
//       expect(e.stackTrace).toContain('Account is locked');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(400);
//     },6000);

//     test('should return http response of locked account', async () => {
//       const authUser : UserLoginRequestDTO = {
//         password : "invalid password",
//         email: users[2].email as string,
//       } 
//       //FIRST REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //SECOND REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //THIRD REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //FOURTH REQUEST
//       await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       //FIFTH REQUEST
//      const res =  await request(app).post('/api/v2/users/login').set({"content-type":"application/json"})
//       .send(JSON.stringify(authUser) )
//       const e = await JSON.parse(res.text)
//       expect(e.title).toEqual('Locked account');
//       expect(e.message).toBe('Account is locked, use forget account to access acount');
//       expect(e.stackTrace).toContain('Account is locked');
//       expect(e).toBeDefined();
//       expect(res.status).toBe(423);
//     },6000);


//     });

});










