import 'reflect-metadata';
import { MongoDBContainer, StartedMongoDBContainer } from '@testcontainers/mongodb';
import { DataSource } from 'typeorm';
import { UserService } from '../src/services/UserService.service';
import { TYPES } from '../src/types/binding.types';
import { iocContainer } from '../src/configs/ioc.config';
import { UserCreationBody } from '../src/types/UserType.type';
import { configureIOC } from '../src/configs/ioc.config';

describe('UserService Integration Test with Testcontainers', () => {
            jest.setTimeout(60000);

    let mongoContainer: MongoDBContainer;
    let mongostartedContainer: StartedMongoDBContainer;
    let dataSource: DataSource;
    let userService: UserService;

    beforeAll(async () => {
        configureIOC();
        // 1. Start the MongoDB container dynamically
        mongoContainer = new MongoDBContainer("mongo:6.0.1");
        mongostartedContainer = await mongoContainer.start();
        const connectionUri = mongostartedContainer.getConnectionString();
        console.log("connection uri : ", connectionUri);

        // 2. Configure and initialize TypeORM DataSource with the dynamic URI
        dataSource = iocContainer?.get<DataSource>(TYPES.DataSource);
        console.log("datasource: ", dataSource)
        Object.assign(dataSource.options, { url: connectionUri });
        (await dataSource.initialize());

        // 3. Resolve the UserService from the container (dependencies will be injected)
        userService = iocContainer.get<UserService>(TYPES.UserService);
        
    },60000);

    afterAll(async () => {
        // 4. Close connections and stop the container
        await dataSource?.destroy();
        await mongostartedContainer?.stop();
    },60000);

    it('should register a new user and find them by email', async () => {
        const email = 'test@example.com';
        const name = 'Test User';
        const age=10;

        // Use the service which uses the injected repository connected to the test DB
        const createUserBody : UserCreationBody ={
            name:name, email: email , age: age
        }
        const newUser = await userService.create(createUserBody);

        expect(newUser).toBeDefined();
        expect(newUser.email).toBe(email);
        expect(newUser.name).toBe(name);

        // const foundUser = await userService.findByEmail(email);
        // expect(foundUser).toEqual(newUser);
    });
});
