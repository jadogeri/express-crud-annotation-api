// src/tests/user.integration.test.ts
import { MongoDBContainer, StartedMongoDBContainer } from "@testcontainers/mongodb";
import mongoose from "mongoose";
import { iocContainer } from "../src/configs/ioc.config";
import { TYPES } from "../src/types/binding.types";
import { UserService } from "../src/services/UserService.service";
import { UserRepository } from "../src/repositories/UserRepository.repository";

describe("UserService Integration Test",  () => {
    let mongoContainer: MongoDBContainer;
    let startedContainer: StartedMongoDBContainer;

    let userService: UserService;
    let userRepository: UserRepository;

    let mongoUri: string;

    beforeAll(async () => {
        try{
        // 1. Start the Testcontainer
        mongoContainer = new MongoDBContainer("mongo:6.0");
        startedContainer = await mongoContainer.start();
        mongoUri = startedContainer.getConnectionString();
        console.log("mongo uri", mongoUri)

        // 2. Connect Mongoose to the Testcontainer DB
        await mongoose.connect(mongoUri);

        // 3. Rebind the Database Connection (or ensure Mongoose uses this global connection)
        // Note: The previous connection manager (if used) might need adjustment. Mongoose manages global connections well.

        // 4. Resolve the service from the container
        userService = iocContainer.get<UserService>(TYPES.UserService);
        userRepository = iocContainer.get<UserRepository>(TYPES.IUserRepository)
        }catch(error: unknown){
            console.log("error......................................", error)
        }
    }, 60000); // Increased timeout for Docker startup

    afterAll(async () => {
        await mongoose.connection.close();
        await startedContainer.stop();
    });

    test("should find no users in an empty DB", async () => {
        const users = await userRepository.find({});
        expect(users.length).toBe(0);
    });
});
